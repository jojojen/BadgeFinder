<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>バッジ識別サービス</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <h1>バッジ識別サービス</h1>
    <div class="container">
        <form id="uploadForm">
            <input type="file" id="image" accept="image/*,.heic,.heif" required>
            <button type="submit" id="identifyBtn">識別開始</button>
        </form>
        <div class="preview-container">
            <div id="preview" class="preview-box"></div>
            <div id="processed-preview" class="preview-box"></div>
        </div>
        <div id="result"></div>
    </div>
    <div class="spinner-overlay" id="spinnerOverlay">
        <div class="spinner"></div>
    </div>

    <!-- heic2any  -->
    <script src="https://cdn.jsdelivr.net/npm/heic2any/dist/heic2any.min.js"></script>

    <script>
        /* --- HEIC/HEIF auto convert to PNG (iOS photo fix) --- */
        async function autoConvertImageIfHeic(file) {
            const isHeic = (
                file.type === "image/heic" ||
                file.type === "image/heif" ||
                file.name.toLowerCase().endsWith(".heic") ||
                file.name.toLowerCase().endsWith(".heif")
            );
            if (!isHeic) return file;

            try {
                let converted = await heic2any({ blob: file, toType: "image/png" });
                if (Array.isArray(converted)) converted = converted[0];
                return new File([converted], file.name.replace(/\.(heic|heif)$/i, ".png"), { type: "image/png" });
            } catch (err) {
                console.error("HEIC convert failed.", err);
                throw new Error("HEIC convert failed.");
            }
        }

        const imageInput      = document.getElementById('image');
        const preview         = document.getElementById('preview');
        const processedPreview= document.getElementById('processed-preview');
        const resultDiv       = document.getElementById('result');
        const uploadForm      = document.getElementById('uploadForm');
        const identifyBtn     = document.getElementById('identifyBtn');
        const spinner         = document.getElementById('spinnerOverlay');

        imageInput.addEventListener('change', async e => {
            preview.innerHTML = processedPreview.innerHTML = resultDiv.innerHTML = '';
            const file = e.target.files[0];
            if (!file) return;

            try {
                const showFile = await autoConvertImageIfHeic(file);
                const reader   = new FileReader();
                reader.onload  = ev => {
                    preview.innerHTML = `<img src="${ev.target.result}" alt="元画像プレビュー">`;
                };
                reader.readAsDataURL(showFile);
            } catch (err) {
                preview.innerHTML = `<p style="color:red;">${err.message}</p>`;
                console.error(err);
            }
        });

        uploadForm.addEventListener('submit', async e => {
            e.preventDefault();
            if (!imageInput.files[0]) return;

            spinner.style.display = 'flex';
            identifyBtn.disabled  = true;

            try {
                let file = await autoConvertImageIfHeic(imageInput.files[0]);
                const formData = new FormData();
                formData.append('image', file);

                /* Preprocess */
                const preResp = await fetch('/preprocess-image', { method:'POST', body:formData });
                const preData = await preResp.json();
                processedPreview.innerHTML = `<img src="${preData.processed_image}" alt="処理後プレビュー">`;

                /* Identify */
                const idResp = await fetch('/identify-badge', { method:'POST', body:formData });
                const idData = await idResp.json();

                const fields = [
                    ['一致状況',    idData.matched ? '✅ データベースに存在します' : 'おめでとうございます！このバッジを初めて発見した方です。'],
                    /* ['画像ハッシュ', idData.image_hash], */
                    ['出典作品',    idData.source_work],
                    ['キャラクター', idData.character],
                    ['購入方法',    idData.purchase_method],
                    ['推奨価格',    idData.suggested_price],
                    ['オークション説明', idData.auction_description]
                ];

                resultDiv.innerHTML = '';
                fields.forEach(([label, value], idx) => {
                    const fid = `field${idx}`;
                    const fieldDiv = document.createElement('div');
                    fieldDiv.className = 'field';
                    fieldDiv.innerHTML = `
                        <span class="field-label">${label}：</span>
                        <span class="field-value" id="${fid}">${value}</span>
                    `;
                    resultDiv.appendChild(fieldDiv);
                });

                document.querySelectorAll('#result .field-value').forEach(span => {
                    span.addEventListener('click', async () => {
                        try {
                            await navigator.clipboard.writeText(span.innerText);
                            span.style.opacity = 0.4;
                            setTimeout(() => (span.style.opacity = ''), 300);
                        } catch {}
                    });
                });
            } catch (err) {
                resultDiv.innerHTML = `<p style="color:red;">${err.message}</p>`;
                console.error(err);
            } finally {
                spinner.style.display = 'none';
                identifyBtn.disabled  = false;
            }
        });
    </script>
</body>
</html>
