<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>ãƒãƒƒã‚¸è­˜åˆ¥ã‚µãƒ¼ãƒ“ã‚¹</title>
    <!-- å¤–éƒ¨ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <h1>ãƒãƒƒã‚¸è­˜åˆ¥ã‚µãƒ¼ãƒ“ã‚¹</h1>
    <div class="container">
        <!-- ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒ  -->
        <form id="uploadForm">
            <input type="file" id="image" accept="image/*,.heic,.heif" required>
            <button type="submit" id="identifyBtn">è­˜åˆ¥é–‹å§‹</button>
        </form>
        <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="preview-container">
            <div id="preview" class="preview-box"></div>
            <div id="processed-preview" class="preview-box"></div>
        </div>
        <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="result"></div>
        <!-- æœªè­˜åˆ¥æ™‚ã«è¡¨ç¤ºã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div id="feedbackForm" style="display: none; margin-top: 1rem;">
            <h2>æƒ…å ±æä¾›ã®ãŠé¡˜ã„</h2>
            <!-- hash ã¨ histogram ã‚’ä¿æŒã™ã‚‹éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
            <input type="hidden" id="feedbackHash">
            <input type="hidden" id="feedbackHist">
            <div>
                <label>å‡ºå…¸ä½œå“: <input type="text" id="sourceWorkInput" placeholder="ä¾‹: ä½œå“å"></label>
            </div>
            <div>
                <label>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼: <input type="text" id="characterInput" placeholder="ä¾‹: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å"></label>
            </div>
            <div>
                <label>è³¼å…¥æ–¹æ³•: <input type="text" id="purchaseMethodInput" placeholder="ä¾‹: ã‚¬ãƒãƒ£/é€šè²©ãªã©"></label>
            </div>
            <div>
                <label>æ¨å¥¨ä¾¡æ ¼: <input type="text" id="suggestedPriceInput" placeholder="ä¾‹: 1000å††"></label>
            </div>
            <div>
                <label>ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³èª¬æ˜: <textarea id="auctionDescriptionInput" rows="3" placeholder="ãã®ä»–ã®æƒ…å ±"></textarea></label>
            </div>
            <button type="button" id="submitFeedbackBtn">é€ä¿¡</button>
        </div>
    </div>
    <!-- èª­ã¿è¾¼ã¿ä¸­ã«è¡¨ç¤ºã™ã‚‹ã‚¹ãƒ”ãƒŠãƒ¼ -->
    <div class="spinner-overlay" id="spinnerOverlay">
        <div class="spinner"></div>
    </div>

    <!-- heic2any  -->
    <script src="https://cdn.jsdelivr.net/npm/heic2any/dist/heic2any.min.js"></script>

    <script>
        /* --- HEIC/HEIF auto convert to PNG (iOS photo fix) --- */
        async function autoConvertImageIfHeic(file) {
            const isHeic = (
                file.type === "image/heic" ||
                file.type === "image/heif" ||
                file.name.toLowerCase().endsWith(".heic") ||
                file.name.toLowerCase().endsWith(".heif")
            );
            if (!isHeic) return file;

            try {
                let converted = await heic2any({ blob: file, toType: "image/png" });
                if (Array.isArray(converted)) converted = converted[0];
                return new File([converted], file.name.replace(/\.(heic|heif)$/i, ".png"), { type: "image/png" });
            } catch (err) {
                console.error("HEIC convert failed.", err);
                throw new Error("HEIC convert failed.");
            }
        }

        const imageInput       = document.getElementById('image');
        const preview          = document.getElementById('preview');
        const processedPreview = document.getElementById('processed-preview');
        const resultDiv        = document.getElementById('result');
        const uploadForm       = document.getElementById('uploadForm');
        const identifyBtn      = document.getElementById('identifyBtn');
        const spinner          = document.getElementById('spinnerOverlay');
        const feedbackForm     = document.getElementById('feedbackForm');
        const feedbackHash     = document.getElementById('feedbackHash');
        const feedbackHist     = document.getElementById('feedbackHist');

        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        imageInput.addEventListener('change', async e => {
            // ä»¥å‰ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»çµæœãƒ»ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
            preview.innerHTML = '';
            processedPreview.innerHTML = '';
            resultDiv.innerHTML = '';
            feedbackForm.style.display = 'none';

            const file = e.target.files[0];
            if (!file) return;

            try {
                const showFile = await autoConvertImageIfHeic(file);
                const reader = new FileReader();
                reader.onload = ev => {
                    preview.innerHTML = `<img src="${ev.target.result}" alt="å…ƒç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">`;
                };
                reader.readAsDataURL(showFile);
            } catch (err) {
                preview.innerHTML = `<p style="color:red;">${err.message}</p>`;
                console.error(err);
            }
        });

        // é€ä¿¡ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®å‡¦ç†: ç”»åƒã‚’é€ä¿¡ã—ã¦å‰å‡¦ç†ãƒ»è­˜åˆ¥
        uploadForm.addEventListener('submit', async e => {
            e.preventDefault();
            if (!imageInput.files[0]) return;

            spinner.style.display = 'flex';
            identifyBtn.disabled  = true;
            feedbackForm.style.display = 'none';

            try {
                // HEIC å¤‰æ›
                let file = await autoConvertImageIfHeic(imageInput.files[0]);
                const formData = new FormData();
                formData.append('image', file);

                /* --- å‰å‡¦ç† --- */
                const preResp = await fetch('/preprocess-image', { method: 'POST', body: formData });
                const preData = await preResp.json();
                // å‡¦ç†å¾Œã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                processedPreview.innerHTML = `<img src="${preData.processed_image}" alt="å‡¦ç†å¾Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">`;

                /* --- ãƒãƒƒã‚¸è­˜åˆ¥ --- */
                const idResp = await fetch('/identify-badge', { method: 'POST', body: formData });
                const idData = await idResp.json();

                // çµæœã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
                resultDiv.innerHTML = '';

                if (idData.matched) {
                    // ä¸€è‡´ã—ãŸå ´åˆ: çµæœã‚’ãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ã§è¡¨ç¤º
                    const fields = [
                        ['ä¸€è‡´çŠ¶æ³',    'âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å­˜åœ¨ã—ã¾ã™'],
                        ['å‡ºå…¸ä½œå“',    idData.source_work],
                        ['ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼', idData.character],
                        ['è³¼å…¥æ–¹æ³•',    idData.purchase_method],
                        ['æ¨å¥¨ä¾¡æ ¼',    idData.suggested_price],
                        ['ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³èª¬æ˜', idData.auction_description]
                    ];
                    fields.forEach(([label, value], idx) => {
                        const fid = `field${idx}`;
                        const fieldDiv = document.createElement('div');
                        fieldDiv.className = 'field';
                        fieldDiv.innerHTML = `
                            <span class="field-label">${label}ï¼š</span>
                            <span class="field-value" id="${fid}">${value}</span>
                        `;
                        resultDiv.appendChild(fieldDiv);
                    });
                    // å„é …ç›®ã®å€¤ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
                    document.querySelectorAll('#result .field-value').forEach(span => {
                        span.addEventListener('click', async () => {
                            try {
                                await navigator.clipboard.writeText(span.innerText);
                                span.style.opacity = 0.4;
                                setTimeout(() => (span.style.opacity = ''), 300);
                            } catch {
                                // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ API ãŒä½¿ãˆãªã„å ´åˆã¯ç„¡è¦–
                            }
                        });
                    });
                } else {
                    // ä¸€è‡´ã—ãªã„å ´åˆ: ãƒ¦ãƒ¼ãƒ¢ãƒ©ã‚¹ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã€æƒ…å ±æä¾›ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
                    resultDiv.innerHTML = '<p>ã†ãƒ¼ã‚“ã€ã“ã®ãƒãƒƒã‚¸ã¯ã¡ã‚‡ã£ã¨çã—ã„ã‚ˆã†ã§ã™ã€‚ã‚‚ã—ã‹ã—ãŸã‚‰æœ¬å½“ã«ãƒ¬ã‚¢ç‰©ã‹ã€ã¾ãŸã¯AIãŒä¼‘æ†©ä¸­ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚åˆ¥ã®ç”»åƒã‚’è©¦ã—ã¦ã¿ã¦ãã ã•ã„ğŸ˜Š</p>';
                    // ãƒãƒƒã‚·ãƒ¥ã¨ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã‚’éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚»ãƒƒãƒˆ
                    feedbackHash.value = idData.image_hash;
                    feedbackHist.value = JSON.stringify(idData.color_hist);
                    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
                    feedbackForm.style.display = 'block';
                }
            } catch (err) {
                resultDiv.innerHTML = `<p style="color:red;">${err.message}</p>`;
                console.error(err);
            } finally {
                spinner.style.display = 'none';
                identifyBtn.disabled  = false;
            }
        });

        // é€ä¿¡ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®å‡¦ç†: ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯é€ä¿¡
        document.getElementById('submitFeedbackBtn').addEventListener('click', async () => {
            const formData = new FormData();
            // éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨å…¥åŠ›å†…å®¹ã‚’è¿½åŠ 
            formData.append('image_hash', feedbackHash.value);
            formData.append('color_hist', feedbackHist.value);
            formData.append('source_work', document.getElementById('sourceWorkInput').value);
            formData.append('character', document.getElementById('characterInput').value);
            formData.append('purchase_method', document.getElementById('purchaseMethodInput').value);
            formData.append('suggested_price', document.getElementById('suggestedPriceInput').value);
            formData.append('auction_description', document.getElementById('auctionDescriptionInput').value);
            try {
                const resp = await fetch('/feedback', { method: 'POST', body: formData });
                const data = await resp.json();
                if (data.status === 'success') {
                    resultDiv.innerHTML = '<p>ã”å”åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼æä¾›ã„ãŸã ã„ãŸæƒ…å ±ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚</p>';
                    feedbackForm.style.display = 'none';
                } else {
                    resultDiv.innerHTML = '<p style="color:red;">é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚</p>';
                }
            } catch (err) {
                console.error(err);
                resultDiv.innerHTML = '<p style="color:red;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å¾Œã§å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚</p>';
            }
        });
    </script>
</body>
</html>
