<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>„Éê„ÉÉ„Ç∏Ë≠òÂà•„Çµ„Éº„Éì„Çπ</title>
    <!-- Link to external stylesheet -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <h1>„Éê„ÉÉ„Ç∏Ë≠òÂà•„Çµ„Éº„Éì„Çπ</h1>
    <div class="container">
        <form id="uploadForm">
            <input type="file" id="image" accept="image/*,.heic,.heif" required>
            <button type="submit" id="identifyBtn">Ë≠òÂà•ÈñãÂßã</button>
        </form>
        <div class="preview-container">
            <div id="preview" class="preview-box"></div>
            <div id="processed-preview" class="preview-box"></div>
        </div>
        <!-- Result display area -->
        <div id="result"></div>
        <!-- Feedback form shown when identification fails -->
        <div id="feedbackForm" style="display: none; margin-top: 1rem;">
            <h2>ÊÉÖÂ†±Êèê‰æõ„ÅÆ„ÅäÈ°ò„ÅÑ</h2>
            <!-- Hidden fields to store hash and histogram -->
            <input type="hidden" id="feedbackHash">
            <input type="hidden" id="feedbackHist">
            <div>
                <label>Âá∫ÂÖ∏‰ΩúÂìÅ: <input type="text" id="sourceWorkInput" placeholder="‰æã: ‰ΩúÂìÅÂêç"></label>
            </div>
            <div>
                <label>„Ç≠„É£„É©„ÇØ„Çø„Éº: <input type="text" id="characterInput" placeholder="‰æã: „Ç≠„É£„É©„ÇØ„Çø„ÉºÂêç"></label>
            </div>
            <div>
                <label>Ë≥ºÂÖ•ÊñπÊ≥ï: <input type="text" id="purchaseMethodInput" placeholder="‰æã: „Ç¨„ÉÅ„É£/ÈÄöË≤©„Å™„Å©"></label>
            </div>
            <div>
                <label>Êé®Â•®‰æ°Ê†º: <input type="text" id="suggestedPriceInput" placeholder="‰æã: 1000ÂÜÜ"></label>
            </div>
            <div>
                <label>„Ç™„Éº„ÇØ„Ç∑„Éß„É≥Ë™¨Êòé: <textarea id="auctionDescriptionInput" rows="3" placeholder="„Åù„ÅÆ‰ªñ„ÅÆÊÉÖÂ†±"></textarea></label>
            </div>
            <button type="button" id="submitFeedbackBtn">ÈÄÅ‰ø°</button>
        </div>
    </div>
    <!-- Spinner overlay shown during processing -->
    <div class="spinner-overlay" id="spinnerOverlay">
        <div class="spinner"></div>
    </div>

    <!-- heic2any library for HEIC/HEIF conversion -->
    <script src="https://cdn.jsdelivr.net/npm/heic2any/dist/heic2any.min.js"></script>

    <script>
        /* --- HEIC/HEIF auto convert to PNG (iOS photo fix) --- */
        async function autoConvertImageIfHeic(file) {
            const isHeic = (
                file.type === "image/heic" ||
                file.type === "image/heif" ||
                file.name.toLowerCase().endsWith(".heic") ||
                file.name.toLowerCase().endsWith(".heif")
            );
            if (!isHeic) return file;

            try {
                let converted = await heic2any({ blob: file, toType: "image/png" });
                if (Array.isArray(converted)) converted = converted[0];
                return new File([converted], file.name.replace(/\.(heic|heif)$/i, ".png"), { type: "image/png" });
            } catch (err) {
                console.error("HEIC convert failed.", err);
                throw new Error("HEIC convert failed.");
            }
        }

        const imageInput       = document.getElementById('image');
        const preview          = document.getElementById('preview');
        const processedPreview = document.getElementById('processed-preview');
        const resultDiv        = document.getElementById('result');
        const uploadForm       = document.getElementById('uploadForm');
        const identifyBtn      = document.getElementById('identifyBtn');
        const spinner          = document.getElementById('spinnerOverlay');
        const feedbackForm     = document.getElementById('feedbackForm');
        const feedbackHash     = document.getElementById('feedbackHash');
        const feedbackHist     = document.getElementById('feedbackHist');

        // Show preview of selected image (and convert HEIC if necessary)
        imageInput.addEventListener('change', async e => {
            preview.innerHTML = processedPreview.innerHTML = resultDiv.innerHTML = '';
            feedbackForm.style.display = 'none';
            const file = e.target.files[0];
            if (!file) return;

            try {
                const showFile = await autoConvertImageIfHeic(file);
                const reader   = new FileReader();
                reader.onload  = ev => {
                    preview.innerHTML = `<img src="${ev.target.result}" alt="ÂÖÉÁîªÂÉè„Éó„É¨„Éì„É•„Éº">`;
                };
                reader.readAsDataURL(showFile);
            } catch (err) {
                preview.innerHTML = `<p style="color:red;">${err.message}</p>`;
                console.error(err);
            }
        });

        // Handle form submission: preprocess and identify badge
        uploadForm.addEventListener('submit', async e => {
            e.preventDefault();
            if (!imageInput.files[0]) return;

            spinner.style.display = 'flex';
            identifyBtn.disabled  = true;
            feedbackForm.style.display = 'none';

            try {
                // Convert HEIC if necessary
                let file = await autoConvertImageIfHeic(imageInput.files[0]);
                const formData = new FormData();
                formData.append('image', file);

                /* Preprocess image */
                const preResp = await fetch('/preprocess-image', { method:'POST', body: formData });
                const preData = await preResp.json();
                processedPreview.innerHTML = `<img src="${preData.processed_image}" alt="Âá¶ÁêÜÂæå„Éó„É¨„Éì„É•„Éº">`;

                /* Identify badge */
                const idResp = await fetch('/identify-badge', { method:'POST', body: formData });
                const idData = await idResp.json();

                // Clear previous results
                resultDiv.innerHTML = '';

                if (idData.matched) {
                    // Existing badge found in DB: display status and metadata
                    const fields = [
                        ['‰∏ÄËá¥Áä∂Ê≥Å',    '‚úÖ „Éá„Éº„Çø„Éô„Éº„Çπ„Å´Â≠òÂú®„Åó„Åæ„Åô'],
                        ['Âá∫ÂÖ∏‰ΩúÂìÅ',    idData.source_work],
                        ['„Ç≠„É£„É©„ÇØ„Çø„Éº', idData.character],
                        ['Ë≥ºÂÖ•ÊñπÊ≥ï',    idData.purchase_channel],
                        ['ÂÖ•ÊâãÈõ£Â∫¶',    idData.acquisition_difficulty],
                        ['„Ç™„Éº„ÇØ„Ç∑„Éß„É≥Ë™¨Êòé', idData.auction_description]
                    ];
                    fields.forEach(([label, value], idx) => {
                        const fid = `field${idx}`;
                        const fieldDiv = document.createElement('div');
                        fieldDiv.className = 'field';
                        fieldDiv.innerHTML = `
                            <span class="field-label">${label}Ôºö</span>
                            <span class="field-value" id="${fid}">${value}</span>
                        `;
                        resultDiv.appendChild(fieldDiv);
                    });
                    // Enable click-to-copy for each field value
                    document.querySelectorAll('#result .field-value').forEach(span => {
                        span.addEventListener('click', async () => {
                            try {
                                await navigator.clipboard.writeText(span.innerText);
                                span.style.opacity = 0.4;
                                setTimeout(() => (span.style.opacity = ''), 300);
                            } catch {
                                // Ignore failures to use clipboard API
                            }
                        });
                    });
                } else {
                    // No existing match in DB: distinguish between Grok success and failure
                    if (idData.source_work !== undefined) {
                        // Grok succeeded and returned metadata ‚Üí first discovery
                        const fields = [
                            ['‰∏ÄËá¥Áä∂Ê≥Å',    'üéâ „Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ„Åì„ÅÆ„Éê„ÉÉ„Ç∏„ÇíÂàù„ÇÅ„Å¶Áô∫Ë¶ã„Åó„ÅüÊñπ„Åß„Åô„ÄÇ'],
                            ['Âá∫ÂÖ∏‰ΩúÂìÅ',    idData.source_work],
                            ['„Ç≠„É£„É©„ÇØ„Çø„Éº', idData.character],
                            ['Ë≥ºÂÖ•ÊñπÊ≥ï',    idData.purchase_channel],
                            ['ÂÖ•ÊâãÈõ£Â∫¶',    idData.acquisition_difficulty],
                            ['„Ç™„Éº„ÇØ„Ç∑„Éß„É≥Ë™¨Êòé', idData.auction_description]
                        ];
                        fields.forEach(([label, value], idx) => {
                            const fid = `field${idx}`;
                            const fieldDiv = document.createElement('div');
                            fieldDiv.className = 'field';
                            fieldDiv.innerHTML = `
                                <span class="field-label">${label}Ôºö</span>
                                <span class="field-value" id="${fid}">${value}</span>
                            `;
                            resultDiv.appendChild(fieldDiv);
                        });
                        // Enable click-to-copy
                        document.querySelectorAll('#result .field-value').forEach(span => {
                            span.addEventListener('click', async () => {
                                try {
                                    await navigator.clipboard.writeText(span.innerText);
                                    span.style.opacity = 0.4;
                                    setTimeout(() => (span.style.opacity = ''), 300);
                                } catch {
                                    // Ignore if clipboard API is unavailable
                                }
                            });
                        });
                    } else {
                        // Grok failed to return metadata ‚Üí show humorous message and ask for user feedback
                        resultDiv.innerHTML = '<p>„ÅÜ„Éº„Çì„ÄÅ„Åì„ÅÆ„Éê„ÉÉ„Ç∏„ÅØ„Å°„Çá„Å£„Å®Áèç„Åó„ÅÑ„Çà„ÅÜ„Åß„Åô„ÄÇ„ÇÇ„Åó„Åã„Åó„Åü„ÇâÊú¨ÂΩì„Å´„É¨„Ç¢Áâ©„Åã„ÄÅ„Åæ„Åü„ÅØAI„Åå‰ºëÊÜ©‰∏≠„Åã„ÇÇ„Åó„Çå„Åæ„Åõ„Çì„ÄÇÂà•„ÅÆÁîªÂÉè„ÇíË©¶„Åó„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ</p>';
                        // Populate hidden inputs with hash and histogram for feedback
                        feedbackHash.value = idData.image_hash;
                        feedbackHist.value = JSON.stringify(idData.color_hist);
                        // Show feedback form
                        feedbackForm.style.display = 'block';
                    }
                }
            } catch (err) {
                resultDiv.innerHTML = `<p style="color:red;">${err.message}</p>`;
                console.error(err);
            } finally {
                spinner.style.display = 'none';
                identifyBtn.disabled  = false;
            }
        });

        // Submit feedback to backend
        document.getElementById('submitFeedbackBtn').addEventListener('click', async () => {
            const formData = new FormData();
            formData.append('image_hash', feedbackHash.value);
            formData.append('color_hist', feedbackHist.value);
            formData.append('source_work', document.getElementById('sourceWorkInput').value);
            formData.append('character', document.getElementById('characterInput').value);
            formData.append('purchase_channel', document.getElementById('purchaseMethodInput').value);
            formData.append('acquisition_difficulty', document.getElementById('suggestedPriceInput').value);
            formData.append('auction_description', document.getElementById('auctionDescriptionInput').value);
            try {
                const resp = await fetch('/feedback', { method: 'POST', body: formData });
                const data = await resp.json();
                if (data.status === 'success') {
                    resultDiv.innerHTML = '<p>„ÅîÂçîÂäõ„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅÊèê‰æõ„ÅÑ„Åü„Å†„ÅÑ„ÅüÊÉÖÂ†±„ÇíÁôªÈå≤„Åó„Åæ„Åó„Åü„ÄÇ</p>';
                    feedbackForm.style.display = 'none';
                } else {
                    resultDiv.innerHTML = '<p style="color:red;">ÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ</p>';
                }
            } catch (err) {
                console.error(err);
                resultDiv.innerHTML = '<p style="color:red;">„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇÂæå„ÅßÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>';
            }
        });
    </script>
</body>
</html>
